<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Parking Fury Ultimate</title>
<style>
body{margin:0;background:#181818;color:white;font-family:Arial;overflow:hidden}
canvas{display:block;margin:auto;background:#2a2a2a}
#ui{position:absolute;top:10px;left:10px}
button{padding:10px;margin:5px;font-size:14px}
#joystick{position:absolute;bottom:20px;left:20px;width:120px;height:120px;border-radius:50%;background:#333;opacity:.8}
#stick{position:absolute;width:50px;height:50px;border-radius:50%;background:#aaa;top:35px;left:35px}
#pedals{position:absolute;bottom:20px;right:20px}
.hidden{display:none}
</style>
</head>

<body>

<div id="ui">
<button onclick="toggleShop()">Skins</button>
<button onclick="toggleEditor()">Editor (E)</button>
</div>

<div id="joystick" class="hidden"><div id="stick"></div></div>
<div id="pedals" class="hidden">
<button id="gas">GAS</button><br>
<button id="brake">BRAKE</button>
</div>

<canvas id="game" width="900" height="550"></canvas>

<script>
/* ================== SETUP ================== */
const c=document.getElementById("game"),ctx=c.getContext("2d");
const isMobile=("ontouchstart"in window);
if(isMobile){
 document.getElementById("joystick").classList.remove("hidden");
 document.getElementById("pedals").classList.remove("hidden");
}

let keys={},editor=false,shop=false;

/* ================== ASSETS ================== */
const imgCar=new Image(); imgCar.src="assets/car_red.png";
const imgPolice=new Image(); imgPolice.src="assets/car_police.png";
const asphalt=new Image(); asphalt.src="assets/asphalt.png";

/* ================== GAME STATE ================== */
let car={x:100,y:250,a:0,v:0};
let police={x:800,y:100,a:0,v:0,active:true};
let parking={x:760,y:260};
let walls=[{x:400,y:0,w:20,h:400}];
let XP=+localStorage.XP||1;
let damage=0;

/* ================== INPUT ================== */
document.onkeydown=e=>{
 keys[e.key]=true;
 if(e.key==="e"||e.key==="E")toggleEditor();
};
document.onkeyup=e=>keys[e.key]=false;

/* ================== MOBILE JOYSTICK ================== */
let joy={x:0,y:0};
const joyDiv=document.getElementById("joystick");
const stick=document.getElementById("stick");

joyDiv?.addEventListener("touchmove",e=>{
 let r=joyDiv.getBoundingClientRect();
 let t=e.touches[0];
 joy.x=(t.clientX-r.left-60)/40;
 joy.y=(t.clientY-r.top-60)/40;
 joy.x=Math.max(-1,Math.min(1,joy.x));
 joy.y=Math.max(-1,Math.min(1,joy.y));
 stick.style.left=35+joy.x*30+"px";
 stick.style.top=35+joy.y*30+"px";
});

/* ================== UPDATE ================== */
function update(){
 let accel=0,turn=0;
 if(keys.w||keys.ArrowUp||joy.y<-0.3)accel=0.2;
 if(keys.s||keys.ArrowDown||joy.y>0.3)accel=-0.2;
 if(keys.a||keys.ArrowLeft||joy.x<-0.3)turn=-0.05;
 if(keys.d||keys.ArrowRight||joy.x>0.3)turn=0.05;

 car.v+=accel; car.v*=0.96; car.a+=turn;
 car.x+=Math.cos(car.a)*car.v;
 car.y+=Math.sin(car.a)*car.v;

 // Police AI chase
 if(police.active){
  let dx=car.x-police.x,dy=car.y-police.y;
  police.a=Math.atan2(dy,dx);
  police.v=0.18;
  police.x+=Math.cos(police.a)*police.v;
  police.y+=Math.sin(police.a)*police.v;
 }

 // Wall collision
 walls.forEach(w=>{
  if(car.x<w.x+w.w&&car.x+40>w.x&&car.y<w.y+w.h&&car.y+20>w.y){
   damage+=10;
   car.v*=-0.4;
  }
 });

 // Park check
 if(car.x>parking.x&&car.y>parking.y&&Math.abs(car.v)<0.4){
  XP++;
  localStorage.XP=XP;
 }
}

/* ================== DRAW ================== */
function draw(){
 ctx.clearRect(0,0,c.width,c.height);
 ctx.drawImage(asphalt,0,0,c.width,c.height);

 // Parking
 ctx.strokeStyle="lime";
 ctx.strokeRect(parking.x,parking.y,50,30);

 // Walls
 ctx.fillStyle="#555";
 walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));

 // Car
 ctx.save();
 ctx.translate(car.x+20,car.y+10);
 ctx.rotate(car.a);
 ctx.drawImage(imgCar,-20,-10,40,20);
 ctx.restore();

 // Police
 if(police.active){
  ctx.save();
  ctx.translate(police.x+20,police.y+10);
  ctx.rotate(police.a);
  ctx.drawImage(imgPolice,-20,-10,40,20);
  ctx.restore();
 }

 ctx.fillStyle="white";
 ctx.fillText("XP: "+XP,10,20);
 ctx.fillText("Damage: "+damage+"%",10,40);

 if(editor){
  ctx.fillStyle="yellow";
  ctx.fillText("EDITOR MODE: Click to place walls",10,60);
 }
}

/* ================== LEVEL EDITOR ================== */
c.addEventListener("click",e=>{
 if(!editor)return;
 let r=c.getBoundingClientRect();
 walls.push({x:e.clientX-r.left,y:e.clientY-r.top,w:20,h:80});
});

/* ================== UI ================== */
function toggleEditor(){editor=!editor}
function toggleShop(){
 alert("Skins Shop\n(Connect Stripe / itch.io API here)");
}

/* ================== LOOP ================== */
function loop(){update();draw();requestAnimationFrame(loop)}
loop();
</script>
</body>
</html>
